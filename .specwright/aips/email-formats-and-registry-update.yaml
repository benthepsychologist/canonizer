aip_id: AIP-canonizer-2025-11-13-001
context:
  background: '**Current State:**

    - Single minimal canonical email schema (`org.canonical/email/jsonschema/1-0-0`)

    - One Gmail transform example

    - No guidance on storage trade-offs or format choices


    **Problem:**

    Email is complex (MIME, encodings, attachments, threading). Different use cases need different levels
    of detail:

    - **Full archival:** Need complete MIME structure, all headers, exact body content

    - **App display:** Need text/HTML bodies, attachments metadata, basic headers

    - **Search indexing:** Need metadata only, body stored separately in S3/blob storage


    **Solution:**

    Follow RFC 8621 JMAP (IETF Standards Track) as authoritative JSON email format, offer three canonical
    targets based on storage/complexity needs.'
  constraints:
  - Must follow RFC 8621 for JMAP schemas
  - Must support "every email that was ever sent to anyone ever"
  - Schemas must be additive-only after v1.0.0 (Iglu SchemaVer)
  - No dependencies on external services (pure transformation)
  - All body content in transforms must handle encoding properly
created: '2025-11-13T11:48:38.721344+00:00'
meta:
  created_at: '2025-11-13T11:48:38.721344+00:00'
  created_by: benthepsychologist
objective:
  acceptance_criteria:
  - Gmail API schema (`com.google/gmail_email/jsonschema/1-0-0`) - validated against real API responses
  - Microsoft Graph/Exchange schema (`com.microsoft/exchange_email/jsonschema/1-0-0`) - validated against
    real API responses
  - JMAP Full (`org.canonical/email_jmap_full/jsonschema/1-0-0`) - Complete RFC 8621 Email object
  - JMAP Lite (`org.canonical/email_jmap_lite/jsonschema/1-0-0`) - 80% use cases, body content inline
  - JMAP Minimal (`org.canonical/email_jmap_minimal/jsonschema/1-0-0`) - Metadata only, blob references
  - '`email/gmail_to_jmap_full@1.0.0` - Gmail → JMAP Full'
  - '`email/gmail_to_jmap_lite@1.0.0` - Gmail → JMAP Lite'
  - '`email/gmail_to_jmap_minimal@1.0.0` - Gmail → JMAP Minimal'
  - '`email/exchange_to_jmap_full@1.0.0` - Exchange → JMAP Full'
  - '`email/exchange_to_jmap_lite@1.0.0` - Exchange → JMAP Lite'
  - '`email/exchange_to_jmap_minimal@1.0.0` - Exchange → JMAP Minimal'
  - '`docs/EMAIL_CANONICALIZATION.md` - Comprehensive guide covering:'
  - Each schema has rich descriptions and examples
  - Each transform has detailed metadata explaining target choice
  - All schemas validate with jsonschema
  - Golden tests for each of 6 transforms
  - Integration tests for full pipeline
  - Coverage ≥70% for new transform code
  - Ruff checks pass
  - Registry validation passes for all transforms
  - All schemas pushed to canonizer-registry
  - All transforms pushed to canonizer-registry
  - REGISTRY_INDEX.json regenerated
  - CI validates all new content
  goal: Establish Canonizer as the Rosetta Stone for email transformation with multiple source and target
    formats
orchestrator_contract:
  artifacts_dir: .aip_artifacts/AIP-canonizer-2025-11-13-001
  logging: jsonl
  state_machine:
    events:
    - run_step
    - await_gate
    - approve
    - reject
    - retry
    - escalate
    - complete
    states:
    - pending
    - running
    - awaiting_human
    - failed
    - succeeded
    - rolled_back
plan:
- description: Source Schemas (Gmail + Exchange)
  gate_ref: 'G0: Schema Design'
  kind: code
  outputs:
  - schemas/com.google/gmail_email/jsonschema/1-0-0.json
  - schemas/com.microsoft/exchange_email/jsonschema/1-0-0.json
  - tests/fixtures/email/gmail/api_response_example.json
  - tests/fixtures/email/exchange/api_response_example.json
  prompt: 'Create JSON schemas for Gmail API v1 and Microsoft Graph API email message resources based
    on official API documentation. Validate against real API response examples.

    1. Research Gmail API v1 users.messages resource structure

    2. Research Microsoft Graph API message resource structure

    3. Create `schemas/com.google/gmail_email/jsonschema/1-0-0.json` (update existing)

    4. Create `schemas/com.microsoft/exchange_email/jsonschema/1-0-0.json` (new)

    5. Add example API responses to `tests/fixtures/email/gmail/` and `tests/fixtures/email/exchange/`

    6. Validate schemas parse fixture examples'
  role: coding_agent
  step_id: step-001
- description: Target Canonical Schemas (JMAP Full/Lite/Minimal)
  gate_ref: 'G0: Schema Design'
  kind: code
  outputs:
  - schemas/org.canonical/email_jmap_full/jsonschema/1-0-0.json
  - schemas/org.canonical/email_jmap_lite/jsonschema/1-0-0.json
  - schemas/org.canonical/email_jmap_minimal/jsonschema/1-0-0.json
  prompt: 'Create three JMAP-based canonical email schemas following RFC 8621 specification:

    1. **JMAP Full** - Complete RFC 8621 Email object (use proposed schema as starting point)

    2. **JMAP Lite** - Simplified with inline body strings instead of bodyStructure/bodyValues

    3. **JMAP Minimal** - Metadata only with blobId references for body content

    Each schema must have:

    - Rich field descriptions

    - Examples in schema

    - Clear use case documentation in description

    - Reference to RFC 8621 where applicable'
  role: coding_agent
  step_id: step-002
- description: Gmail Transforms (3 variants)
  gate_ref: 'G1: Transform Implementation'
  kind: code
  outputs:
  - transforms/email/gmail_to_jmap_full/1.0.0/*
  - transforms/email/gmail_to_jmap_lite/1.0.0/*
  - transforms/email/gmail_to_jmap_minimal/1.0.0/*
  prompt: 'Create three JSONata transforms from Gmail API format to each canonical target:

    1. `transforms/email/gmail_to_jmap_full/1.0.0/spec.jsonata`

    2. `transforms/email/gmail_to_jmap_lite/1.0.0/spec.jsonata`

    3. `transforms/email/gmail_to_jmap_minimal/1.0.0/spec.jsonata`

    Each transform needs:

    - `spec.jsonata` - JSONata transformation logic

    - `spec.meta.yaml` - Metadata with provenance, checksums, status

    - `tests/input.json` - Gmail API response example

    - `tests/expected.json` - Expected canonical output

    - Handle base64url decoding for body content

    - Parse headers array into structured fields

    - Convert internalDate to ISO 8601'
  role: coding_agent
  step_id: step-003
- description: Exchange Transforms (3 variants)
  gate_ref: 'G1: Transform Implementation'
  kind: code
  outputs:
  - transforms/email/exchange_to_jmap_full/1.0.0/*
  - transforms/email/exchange_to_jmap_lite/1.0.0/*
  - transforms/email/exchange_to_jmap_minimal/1.0.0/*
  prompt: 'Create three JSONata transforms from Microsoft Graph/Exchange format to each canonical target:

    1. `transforms/email/exchange_to_jmap_full/1.0.0/spec.jsonata`

    2. `transforms/email/exchange_to_jmap_lite/1.0.0/spec.jsonata`

    3. `transforms/email/exchange_to_jmap_minimal/1.0.0/spec.jsonata`

    Each transform needs same structure as Gmail transforms. Exchange API uses direct property access
    (simpler than Gmail''s nested payload structure).'
  role: coding_agent
  step_id: step-004
- description: Comprehensive Documentation
  gate_ref: 'G2: Documentation Review'
  kind: code
  outputs:
  - docs/EMAIL_CANONICALIZATION.md
  prompt: "Create `docs/EMAIL_CANONICALIZATION.md` - the definitive guide to email transformation in Canonizer.\n\
    Must include:\n1. **Overview** - Why email canonicalization, why JMAP\n2. **RFC 8621 JMAP Explanation**\
    \ - What it is, why authoritative\n3. **Canonical Formats Comparison Table**\n   - JMAP Full vs Lite\
    \ vs Minimal\n   - Storage costs, use cases, field counts\n4. **Source Format Documentation**\n  \
    \ - Gmail API structure explanation\n   - Exchange API structure explanation\n5. **Transform Matrix**\
    \ - 2×3 grid showing all transforms\n6. **Usage Examples** - Complete workflows for each use case\n\
    7. **Field Mapping Tables** - Detailed mappings for each transform\n8. **Storage Strategy Guide**\
    \ - When to use blob refs vs inline\n9. **Links & References** - RFC 8621, API docs, JMAP.io\nAlso\
    \ update:\n- `README.md` - Add email canonicalization section\n- Each schema file - Add rich descriptions\
    \ and examples"
  role: coding_agent
  step_id: step-005
- description: Integration Testing
  gate_ref: 'G2: Pre-Release'
  kind: code
  outputs:
  - tests/integration/test_email_transforms.py
  prompt: 'Create comprehensive integration tests for the full email transformation pipeline:

    1. Test each of 6 transforms end-to-end

    2. Test transform chaining (if applicable)

    3. Test error handling (invalid input, missing fields)

    4. Test encoding edge cases (UTF-8, special chars, base64)

    5. Test attachment handling

    6. Validate all outputs against target schemas'
  role: coding_agent
  step_id: step-006
- description: Registry Updates & CI
  gate_ref: 'G3: Registry Publication'
  kind: code
  prompt: 'Push all new schemas and transforms to canonizer-registry repository:

    1. Copy schemas to registry repo structure

    2. Copy transforms to registry repo structure

    3. Run `tools/validate.py` on all new content

    4. Run `tools/generate_index.py` to update REGISTRY_INDEX.json

    5. Commit and push to registry repo

    6. Verify CI passes'
  role: coding_agent
  step_id: step-007
- description: Final Validation & Release
  gate_ref: 'G4: Release Approval'
  kind: code
  outputs:
  - CHANGELOG.md
  prompt: 'Final end-to-end validation and release preparation:

    1. Test all 6 transforms via registry commands

    2. Run full test suite

    3. Update CHANGELOG.md with email canonicalization feature

    4. Create release notes

    5. Tag version if appropriate'
  role: coding_agent
  step_id: step-008
project_slug: canonizer
repo:
  default_branch: main
  url: git@github.com:benthepsychologist/canonizer.git
  working_branch: feat/email-canonicalization-jmap
spec_version: 1.0.0
tier: B
title: Email Canonicalization Standards (JMAP-based)
updated: '2025-11-13T11:52:00+00:00'
version: '0.1'

